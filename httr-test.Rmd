
```{r}
library(httr2)
library(rvest)
library(tidyverse)
library(lubridate)
source("teams_fns.R")
source("soccerway_fns.R")
source("comp_fns.R")
source("update.R")
```

initialize games, teams, comps to empty

```{r}
# initial game numbers
# games <- game_numbers_to_info()
```


initialize

```{r}
game_id <- sample(3510000:3540000, 5)
games <- game_numbers_to_info(game_id)
games
```

some teams

```{r}
team_id <- sample(1:50000, 5)
team_id
teams <- numbers_to_team(team_id)
teams
```

this goes in number_to_country

```{r}
team_id <- 688
team_id <- 12046
url_base <- "https://uk.soccerway.com/teams/estonia/jalgpalliklubi-fc-flora/"
url <- str_c(url_base, team_id, "/")
content <- url_to_content(url)

content %>% html_nodes(xpath = '//*[@id="page_team_1_block_team_info_7"]/div/div[2]') -> dl 
dl %>% html_nodes("dt") %>% html_text() -> heading
dl %>% html_nodes("dd") %>% html_text() -> entry
tibble(heading, entry) %>% filter(heading == "Country") %>% pull("entry")
# number_to_team(688)
```


```{r}
game_ids <- sample(3510000:3540000, 5)
game_ids
games <- update_games(game_ids, games)
games
```

update teams

```{r}
teams <- update_teams(teams, games)
teams %>% unnest_wider(country) %>% View()
```

sometimes the wrong bit is extracted from the team info (it could be second or third)

```{r}
number_to_country(12046)
```


update comps

```{r}
comps <- update_comps(comps, games)
comps
```




display games

```{r}
games %>% 
  left_join(teams, by = c("t1"="id")) %>% 
  left_join(teams, by = c("t2"="id")) %>% 
  left_join(comps, by = c("comp" = "comp_id")) %>% 
  select(game, name.x, name.y, score, status, where, comp_name, timestamp) %>% 
  arrange(game)
```



```{r}
write_rds(games, "games.rds")
write_rds(teams, "teams.rds")
write_rds(comps, "comps.rds")
```

